<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa de Cobertura - The Brotherts (2km)</title>
    <!-- Carregamento do Tailwind CSS para estilização rápida e responsiva -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Define a altura total da tela para o mapa */
        #map {
            width: 100%;
            height: calc(100vh - 400px); /* Aumentei o espaço para acomodar o formulário */
            min-height: 450px;
            border-radius: 1rem; /* Cantos mais arredondados */
        }
        .color-dot {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            margin-right: 8px;
            box-shadow: 0 0 5px rgba(0,0,0,0.2);
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary-blue': '#4F46E5', /* Indigo-600 */
                        'primary-dark': '#1F2937', /* Gray-800, Usado como preto no cabeçalho */
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-100 font-sans p-4 flex justify-center">

    <div class="w-full max-w-7xl">
        <header class="mb-6 bg-primary-dark shadow-xl p-6 rounded-xl">
            <h1 class="text-3xl font-extrabold text-white mb-1">Visualização de Cobertura - The Brothers Jiu Jitsu</h1>
            <p class="text-gray-300">Áreas de 2 km em torno das academias, coloridas por região para fácil identificação.</p>
            
            <div id="loading" class="mt-3 text-sm text-yellow-400 flex items-center">
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-yellow-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Carregando Google Maps...
            </div>

            <!-- Legenda de Cores -->
            <div id="legend" class="mt-4 pt-4 border-t border-gray-700">
                <h2 class="text-base font-bold text-white mb-2">Legenda por Área:</h2>
                <div class="flex flex-wrap gap-x-6 gap-y-2 text-sm">
                    <!-- A legenda será preenchida dinamicamente pelo JavaScript abaixo (função createLegend) -->
                </div>
            </div>

            <!-- Formulário de Adição de Localização -->
            <div class="mt-6 pt-4 border-t border-gray-700">
                <h2 class="text-base font-bold text-white mb-3">Adicionar Nova Academia (Usando Endereço):</h2>
                <form id="new-location-form" class="grid grid-cols-1 sm:grid-cols-6 gap-3">
                    <input type="text" id="name" placeholder="Nome da Academia" required class="col-span-6 sm:col-span-3 p-2 rounded bg-gray-700 text-white placeholder-gray-400 focus:ring-primary-blue focus:border-primary-blue border-transparent">
                    <input type="text" id="bairro" placeholder="Bairro" required class="col-span-6 sm:col-span-1 p-2 rounded bg-gray-700 text-white placeholder-gray-400 focus:ring-primary-blue focus:border-primary-blue border-transparent">
                    <input type="text" id="cidade" placeholder="Cidade/UF" required class="col-span-6 sm:col-span-2 p-2 rounded bg-gray-700 text-white placeholder-gray-400 focus:ring-primary-blue focus:border-primary-blue border-transparent">
                    
                    <!-- NOVO CAMPO DE ENDEREÇO -->
                    <input type="text" id="rua_numero" placeholder="Rua, Número (ex: Av. Boa Viagem, 100)" required class="col-span-6 sm:col-span-4 p-2 rounded bg-gray-700 text-white placeholder-gray-400 focus:ring-primary-blue focus:border-primary-blue border-transparent">

                    <button type="button" onclick="addLocation()" class="col-span-6 sm:col-span-2 bg-primary-blue text-white font-bold py-2 px-4 rounded hover:bg-indigo-700 transition duration-150 shadow-md">
                        Adicionar ao Mapa
                    </button>
                </form>
                <div id="message-box" class="mt-3 p-2 rounded text-sm text-center font-semibold hidden"></div>
            </div>
        </header>

        <!-- Container do Mapa -->
        <div id="map" class="shadow-2xl"></div>
    </div>

    <script type="text/javascript">
        let map;
        let geocoder; // Adicionando o Geocoder
        let mapElements = []; // Variável global para rastrear círculos e marcadores no mapa.

        // --- Mapeamento de Cores por Bairro/Cidade ---
        const NEIGHBORHOOD_COLORS = {
            "Boa Viagem": { stroke: "#4CAF50", fill: "#4CAF50", display: "Boa Viagem (Recife/PE)" },
            "Ipsep": { stroke: "#FF9800", fill: "#FF9800", display: "Ipsep (Recife/PE)" },
            "Afogados": { stroke: "#03A9F4", fill: "#03A9F4", display: "Afogados (Recife/PE)" },
            "Vila Tamandaré": { stroke: "#9C27B0", fill: "#9C27B0", display: "Vila Tamandaré (Recife/PE)" },
            "Jardim S. Paulo": { stroke: "#E91E63", fill: "#E91E63", display: "Jardim S. Paulo (Recife/PE)" },
            "Ibura de Baixo": { stroke: "#FFC107", fill: "#FFC107", display: "Ibura de Baixo (Recife/PE)" },
            "Artur Lundgren L": { stroke: "#00BCD4", fill: "#00BCD4", display: "Artur Lundgren L (Paulista/PE)" },
            "Ouro Preto": { stroke: "#3F51B5", fill: "#3F51B5", display: "Ouro Preto (Ouro Preto/MG)" },
            "Centro": { stroke: "#607D8B", fill: "#607D8B", display: "Centro (Ibiúna/SP)" },
            "Barro": { stroke: "#795548", fill: "#795548", display: "Barro (Recife/PE)" },
            "default": { stroke: "#000000", fill: "#000000", display: "Desconhecido" }
        };

        // --- Configuração das Coordenadas com Bairro/Cidade ---
        const theBrothertsLocations = [
            // Coordenadas corrigidas via busca de endereço:
            { lat: -8.129373, lng: -34.901502, name: "The Brothers BJJ", bairro: "Boa Viagem", cidade: "Recife/PE" },
            { lat: -8.113264, lng: -34.918928, name: "The Brothers Ipsep", bairro: "Ipsep", cidade: "Recife/PE" },
            { lat: -8.077274, lng: -34.909062, name: "The Brothers Afogados", bairro: "Afogados", cidade: "Recife/PE" },
            { lat: -8.093394, lng: -34.925000, name: "The Brothers Vila Tamandaré", bairro: "Vila Tamandaré", cidade: "Recife/PE" },
            { lat: -8.086383, lng: -34.939023, name: "The Brothers Jardim S. Paulo", bairro: "Jardim S. Paulo", cidade: "Recife/PE" },
            { lat: -8.114777, lng: -34.936608, name: "The Brothers Ibura", bairro: "Ibura de Baixo", cidade: "Recife/PE" },
            { lat: -7.935123, lng: -34.894767, name: "The Brothers BJJ BRASIL", bairro: "Artur Lundgren L", cidade: "Paulista/PE" },
            
            // Locais de outras cidades
            { lat: -20.3895368, lng: -43.5032012, name: "Academia THE BROTHERS", bairro: "Ouro Preto", cidade: "Ouro Preto/MG" },
            { lat: -23.6557566, lng: -47.2132838, name: "The brothers studio", bairro: "Centro", cidade: "Ibiúna/SP" },
        ];

        /**
         * Limpa os elementos antigos (marcadores e círculos) do mapa.
         */
        function clearMapElements() {
            mapElements.forEach(element => element.setMap(null));
            mapElements = [];
        }

        /**
         * Função que preenche a legenda no cabeçalho, mostrando apenas os bairros presentes.
         */
        function createLegend() {
            const legendContainer = document.querySelector('#legend > div');
            
            legendContainer.innerHTML = ''; 

            const uniqueBairros = new Set(theBrothertsLocations.map(loc => loc.bairro));

            uniqueBairros.forEach(bairro => {
                const colorData = NEIGHBORHOOD_COLORS[bairro] || NEIGHBORHOOD_COLORS["default"];
                const item = document.createElement('div');
                item.className = 'flex items-center hover:bg-gray-700 p-1 rounded transition duration-150 ease-in-out cursor-default'; 
                item.innerHTML = `
                    <div class="color-dot" style="background-color: ${colorData.fill};"></div>
                    <span class="text-gray-200">${colorData.display}</span>
                `; 
                legendContainer.appendChild(item);
            });
        }

        /**
         * Desenha todos os locais de 'theBrothertsLocations' no mapa.
         */
        function drawLocations() {
            if (!map) return;
            
            clearMapElements(); // Limpa os elementos antes de redesenhar
            
            const bounds = new google.maps.LatLngBounds();

            theBrothertsLocations.forEach(location => {
                const center = { lat: location.lat, lng: location.lng };
                
                // Obtém os dados de cor baseado no bairro.
                let colorKey = location.bairro;
                
                // Se o bairro for novo e não tiver cor definida, define uma cor padrão (Hot Pink)
                if (!NEIGHBORHOOD_COLORS[colorKey]) {
                    NEIGHBORHOOD_COLORS[colorKey] = { 
                        stroke: "#FF69B4", // Hot Pink para novos bairros não mapeados
                        fill: "#FF69B4", 
                        display: `${location.bairro} (${location.cidade}) - NOVO`,
                        isNew: true
                    };
                }
                const colorData = NEIGHBORHOOD_COLORS[colorKey];

                // Cria o objeto Circle: 'radius' é definido em metros (2000 m = 2 km).
                const cityCircle = new google.maps.Circle({
                    strokeColor: colorData.stroke,
                    strokeOpacity: 0.8,
                    strokeWeight: 2,
                    fillColor: colorData.fill,
                    fillOpacity: 0.3,
                    map,
                    center: center,
                    radius: 2000,
                });
                mapElements.push(cityCircle); 

                // Adiciona um Marcador no centro do círculo (também colorido)
                const marker = new google.maps.Marker({
                    position: center,
                    map,
                    title: `${location.name} - ${location.bairro}`,
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 7,
                        fillColor: colorData.fill,
                        fillOpacity: 0.8,
                        strokeWeight: 1,
                        strokeColor: '#FFFFFF',
                    }
                });
                mapElements.push(marker);
                
                // Adiciona uma janela de informação ao clicar
                const infoWindow = new google.maps.InfoWindow({
                    content: `
                        <div class="text-sm p-1">
                            <h3 class="font-bold text-primary-dark">${location.name}</h3>
                            <p class="mb-1 text-gray-700">Bairro: <span class="font-semibold">${location.bairro} (${location.cidade})</span></p>
                            <p class="text-xs text-gray-500">Raio de Cobertura: 2 km</p>
                        </div>
                    `,
                });

                marker.addListener("click", () => {
                    infoWindow.open({
                        anchor: marker,
                        map,
                    });
                });

                bounds.extend(new google.maps.LatLng(location.lat, location.lng));
            });

            // Ajusta o zoom do mapa para incluir todos os pontos
            if (theBrothertsLocations.length > 0) {
                map.fitBounds(bounds);
            } else {
                // Se não houver locais, centraliza no Brasil
                map.setCenter({ lat: -15.78, lng: -47.92 }); 
                map.setZoom(4);
            }

            createLegend(); // Atualiza a legenda após desenhar (para incluir novas cores)
        }

        /**
         * Função de callback chamada pela API do Google Maps para inicializar o mapa.
         */
        function initMap() {
            document.getElementById('loading').classList.add('hidden');
            
            const initialCenter = { lat: -18.5, lng: -45.0 }; 
            const initialZoom = 5; 
            
            map = new google.maps.Map(document.getElementById("map"), {
                center: initialCenter,
                zoom: initialZoom,
                mapId: "DEMO_MAP_ID",
                disableDefaultUI: true,
                zoomControl: true,
            });
            
            geocoder = new google.maps.Geocoder(); // Inicializa o Geocoder
            drawLocations(); // Desenha todos os locais
        }


        /**
         * Adiciona uma nova localização ao array usando Geocodificação.
         */
        function addLocation() {
            const name = document.getElementById('name').value.trim();
            const rua_numero = document.getElementById('rua_numero').value.trim();
            const bairro = document.getElementById('bairro').value.trim();
            const cidade = document.getElementById('cidade').value.trim();
            const messageBox = document.getElementById('message-box');
            
            messageBox.classList.add('hidden');
            messageBox.classList.remove('text-red-400', 'text-green-400', 'bg-red-900', 'bg-green-900');

            // Validação de campos obrigatórios
            if (!name || !bairro || !cidade || !rua_numero) {
                messageBox.textContent = 'Erro: Preencha todos os campos obrigatórios (Nome, Rua/Número, Bairro e Cidade/UF).';
                messageBox.classList.remove('hidden');
                messageBox.classList.add('text-red-400', 'bg-red-900');
                return;
            }

            const fullAddress = `${rua_numero}, ${bairro}, ${cidade}, Brasil`;

            // Chama o serviço de Geocodificação
            geocoder.geocode({ address: fullAddress }, (results, status) => {
                if (status === 'OK' && results[0]) {
                    // Sucesso na geocodificação
                    const lat = results[0].geometry.location.lat();
                    const lng = results[0].geometry.location.lng();

                    const newLocation = {
                        lat: lat,
                        lng: lng,
                        name: name,
                        bairro: bairro,
                        cidade: cidade
                    };

                    // Adiciona ao array principal
                    theBrothertsLocations.push(newLocation);

                    // Atualiza o mapa para incluir o novo ponto
                    drawLocations();

                    // Limpa o formulário e mostra mensagem de sucesso
                    document.getElementById('new-location-form').reset();
                    messageBox.textContent = `Academia "${name}" adicionada com sucesso ao mapa! (Coordenadas: ${lat.toFixed(6)}, ${lng.toFixed(6)})`;
                    messageBox.classList.remove('hidden');
                    messageBox.classList.add('text-green-400', 'bg-green-900');
                } else {
                    // Erro na geocodificação
                    let errorMessage = `Erro ao encontrar o endereço: "${fullAddress}". Status: ${status}. Verifique se o endereço está correto.`;
                    
                    if (status === 'ZERO_RESULTS') {
                        errorMessage = `Erro: O Google Maps não encontrou resultados para o endereço fornecido. Por favor, revise o Endereço e Número, Bairro e Cidade.`;
                    } else if (status === 'OVER_QUERY_LIMIT') {
                        errorMessage = `Erro: Limite de requisições excedido. Tente novamente mais tarde.`;
                    }
                    
                    messageBox.textContent = errorMessage;
                    messageBox.classList.remove('hidden');
                    messageBox.classList.add('text-red-400', 'bg-red-900');
                }
            });
        }

        // --- Tratamento de Erro do Google Maps ---
        function gm_authFailure() {
            // Mensagem de erro para o caso de chave API inválida
            const loadingElement = document.getElementById('loading');
            loadingElement.innerHTML = 'ERRO: Falha na autenticação da API do Google Maps. Por favor, insira uma chave API válida no script tag ao final do arquivo.';
            loadingElement.classList.remove('text-yellow-400', 'animate-spin', 'flex');
            loadingElement.classList.add('text-red-400', 'font-bold', 'block');
        }

    </script>

    <!-- 
        ATENÇÃO: Este erro é geralmente causado pela falta de uma chave API válida 
        do Google Maps, ou se o faturamento (billing) não estiver ativado no seu 
        projeto do Google Cloud. 
        Você DEVE substituir o "key=" vazio pela sua chave API.
    -->
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=&callback=initMap&v=weekly">
    </script>
</body>
</html>
